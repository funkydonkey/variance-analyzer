# Исправление workflow маппинга столбцов

## Проблема

При загрузке файла пользователь получал предложение маппинга от агента, но после подтверждения ("да") агент "забывал" контекст и просил загрузить файл заново.

### Причины проблемы:

1. **Потеря контекста между сообщениями**: OpenAI Agents SDK использует SQLiteSession для хранения истории, но агент не сохранял информацию о предложенном маппинге в явном виде.

2. **Streamlit rerun сбрасывал глобальные переменные**: При каждом `st.rerun()` глобальные переменные в `ai/tools.py` сбрасывались (хотя и восстанавливались из `session_state`).

3. **Агент не распознавал короткие подтверждения**: Когда пользователь писал "да", агент не понимал, что это относится к предыдущему предложению маппинга.

## Решение: State Machine в UI

Вместо того чтобы полагаться на память агента, мы реализовали **state machine** на уровне Streamlit UI, который:

1. Отслеживает состояние workflow маппинга
2. Автоматически перехватывает подтверждения пользователя
3. Вызывает `apply_column_mapping` от имени пользователя

### Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ                              │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────┐
│                  STREAMLIT UI (new_ui.py)                    │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │          STATE MACHINE                                 │  │
│  │                                                         │  │
│  │  awaiting_mapping_confirmation: bool                   │  │
│  │  pending_mapping: dict                                 │  │
│  │                                                         │  │
│  │  IF awaiting_confirmation AND user says "да":         │  │
│  │    → Auto-send "Примени маппинг..." to Agent          │  │
│  │    → Clear flags                                       │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────┐
│              AI AGENT (variance_agent.py)                    │
│                                                               │
│  Получает либо:                                              │
│  1. "Проанализируй столбцы" → analyze_uploaded_file_columns │
│  2. "Примени маппинг..." → apply_column_mapping             │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────────┐
│                    TOOLS (ai/tools.py)                       │
│                                                               │
│  analyze_uploaded_file_columns():                            │
│    → Сохраняет pending_mapping в session_state              │
│    → Устанавливает awaiting_confirmation = True             │
│                                                               │
│  apply_column_mapping():                                     │
│    → Применяет маппинг к DataFrame                          │
│    → Сохраняет результат в session_state                    │
└─────────────────────────────────────────────────────────────┘
```

## Изменённые файлы

### 1. `ai/tools.py` (строки 160-220)

**Добавлено:**
```python
# В analyze_uploaded_file_columns():
st.session_state.pending_mapping = {
    "account": suggested.account,
    "period": suggested.period,
    "actual": suggested.actual,
    "budget": suggested.budget
}
st.session_state.awaiting_mapping_confirmation = True
```

**Зачем:** Сохраняем предложенный маппинг в `session_state` для использования UI при подтверждении.

---

### 2. `new_ui.py` (строки 159-215)

**Добавлено:** State machine для обработки подтверждения маппинга

```python
# Проверяем, ожидаем ли подтверждение маппинга
if st.session_state.get("awaiting_mapping_confirmation", False):
    confirmation_keywords = ["да", "yes", "ок", "ok", ...]

    if any(keyword in user_prompt_lower for keyword in confirmation_keywords):
        # Автоматически применяем маппинг
        pending_mapping = st.session_state.get("pending_mapping")
        apply_prompt = f"Примени маппинг столбцов: ..."

        # Вызываем агента с готовым промптом
        full_response = st.write_stream(
            st.session_state.analyst.chat_stream(apply_prompt)
        )
```

**Зачем:**
- UI перехватывает короткие подтверждения ("да", "yes", etc.)
- Автоматически формирует запрос на применение маппинга
- Передаёт его агенту вместо исходного "да"

---

### 3. `ai/variance_agent.py` (строки 111-145)

**Изменено:** Инструкции агента для нового workflow

```python
**НОВЫЙ WORKFLOW (ОБЯЗАТЕЛЬНО СЛЕДУЙ):**

1. Когда ты вызываешь `analyze_uploaded_file_columns()`:
   - Инструмент автоматически сохранит маппинг в памяти UI
   - Покажи пользователю маппинг и попроси подтверждения

2. Когда пользователь подтверждает:
   - UI АВТОМАТИЧЕСКИ перехватит сообщение
   - UI сам вызовет `apply_column_mapping()`
   - Ты получишь уже готовый результат

3. Если пользователь корректирует:
   - Ты можешь вызвать `apply_column_mapping()` вручную
```

**Зачем:** Объясняем агенту новую логику, чтобы он не пытался сам обработать "да".

## Как это работает (пример)

### Сценарий 1: Успешное подтверждение

```
1. Пользователь загружает test_upload_file.csv
   → UI: автоматически отправляет "Проанализируй столбцы"

2. Агент вызывает analyze_uploaded_file_columns()
   → Tool: сохраняет pending_mapping в session_state
   → Tool: устанавливает awaiting_confirmation = True
   → Агент: показывает маппинг пользователю

3. Пользователь пишет "да"
   → UI: обнаруживает awaiting_confirmation = True
   → UI: распознаёт "да" как подтверждение
   → UI: формирует prompt "Примени маппинг столбцов: ..."
   → UI: отправляет этот prompt агенту (вместо "да")

4. Агент получает "Примени маппинг..."
   → Агент вызывает apply_column_mapping(account_column="Account Name", ...)
   → Tool: применяет маппинг к DataFrame
   → Tool: сохраняет результат в session_state
   → Агент: сообщает об успехе

5. UI очищает флаги:
   → awaiting_confirmation = False
   → pending_mapping = None
```

### Сценарий 2: Пользователь корректирует маппинг

```
1-2. [то же самое]

3. Пользователь пишет "Столбец 'Month' это period, а 'Actual Amount' это actual"
   → UI: обнаруживает, что это не короткое подтверждение
   → UI: очищает awaiting_confirmation = False
   → UI: передаёт исходное сообщение агенту

4. Агент анализирует корректировку
   → Агент вызывает apply_column_mapping() с новыми параметрами
```

## Преимущества решения

✅ **Надёжность**: UI контролирует workflow, не полагаясь на память агента

✅ **Простота**: Агенту не нужно "помнить" контекст - UI делает это за него

✅ **Гибкость**: Пользователь всё ещё может корректировать маппинг

✅ **Отказоустойчивость**: Если пользователь пишет что-то неожиданное, UI просто отменяет ожидание

## Тестирование

### Что нужно проверить:

1. **Базовый flow:**
   - Загрузить `test_upload_file.csv`
   - Дождаться предложения маппинга
   - Написать "да"
   - Убедиться, что маппинг применён

2. **Вариации подтверждения:**
   - "yes", "ок", "OK", "верно", "+", "apply"
   - Все должны работать

3. **Корректировка:**
   - Написать что-то длиннее 3 слов после предложения маппинга
   - Агент должен обработать как корректировку

4. **Повторная загрузка:**
   - Загрузить файл → подтвердить маппинг
   - Загрузить другой файл → снова подтвердить
   - Убедиться, что нет "утечек" состояния

### Команда для запуска:

```bash
streamlit run new_ui.py
```

### Debug-логи:

В консоли будут видны:
```
[DEBUG] Saved pending_mapping to session_state: {...}
[DEBUG] Detected mapping confirmation: 'да'
[DEBUG SYNC] Restored uploaded_dataframe from session_state: shape=(8, 4)
```

## Возможные улучшения (future work)

1. **Visual feedback**: Показывать индикатор "ожидаю подтверждения" в UI
2. **Кнопки подтверждения**: Добавить кнопки "✅ Принять" / "✏️ Изменить" вместо текстового ввода
3. **История маппингов**: Сохранять историю маппингов для разных файлов
4. **Auto-retry**: Если маппинг не сработал, предложить альтернативы

## Troubleshooting

### Проблема: Маппинг всё равно не применяется

**Диагностика:**
1. Проверь логи в консоли
2. Убедись, что `st.session_state.awaiting_mapping_confirmation` установлен в `True` после анализа
3. Проверь, что глобальные переменные `tools._uploaded_dataframe` не `None`

**Решение:**
```python
# Добавь в начало new_ui.py:
print(f"[DEBUG] awaiting_confirmation: {st.session_state.get('awaiting_mapping_confirmation')}")
print(f"[DEBUG] pending_mapping: {st.session_state.get('pending_mapping')}")
```

### Проблема: Агент игнорирует "да"

**Причина:** UI не перехватил подтверждение (возможно, ключевое слово не распознано)

**Решение:** Добавь своё ключевое слово в список `confirmation_keywords` (new_ui.py:170)

---

**Дата:** 2024-12-18
**Автор:** Claude Code (Mentor)
**Версия:** 1.0

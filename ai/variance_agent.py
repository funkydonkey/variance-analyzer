"""AI –∞–≥–µ–Ω—Ç –¥–ª—è variance analysis —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI Agents SDK."""
import asyncio
from pathlib import Path
from time import sleep
from agents import Agent, Runner, SQLiteSession, run_demo_loop
from ai.tools import (
    get_summary_stats,
    get_top_variances,
    get_variance_data,
    analyze_uploaded_file_columns,
    apply_column_mapping,
    get_mapped_variance_data,
    get_mapped_top_variances
)

class VarianceAnalyst:
    """
    AI –∞–≥–µ–Ω—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è variance analysis.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI Agents SDK –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    """

    def __init__(self, data_file: str):
        """
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞.

            Args:
                data_file: –ü—É—Ç—å –∫ CSV/XLSX —Ñ–∞–π–ª—É —Å –¥–∞–Ω–Ω—ã–º–∏
        """
        self.data_file = str(Path(data_file).absolute())

        self.agent = Agent(
            name="Variance Analyst",
            instructions=self._get_instructions(),
            tools=[
                get_summary_stats,
                get_top_variances,
                get_variance_data,
                analyze_uploaded_file_columns,
                apply_column_mapping,
                get_mapped_variance_data,
                get_mapped_top_variances
            ],
            model="gpt-4o"
        )

        self.session = SQLiteSession("variance_analysis")

    def _get_instructions(self) -> str:
        """–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞."""
        return f"""
        –¢—ã - AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ variance (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É —Ñ–∞–∫—Ç–æ–º –∏ –±—é–¥–∂–µ—Ç–æ–º).

        # –¢–≤–æ—è —Ä–æ–ª—å
        1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        2. –ü–æ–º–æ–≥–∞—Ç—å —Å –º–∞–ø–ø–∏–Ω–≥–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        3. –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ variance –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º
        4. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ insights –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

        # –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
        - –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        - –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–∏—Ñ—Ä—ã - —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –±–æ–ª—å—à–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (>20%), –æ–±—Ä–∞—â–∞–π –Ω–∞ –Ω–∏—Ö –≤–Ω–∏–º–∞–Ω–∏–µ
        - –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—ã Markdown –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        - –û–±—ä—è—Å–Ω—è–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç–æ–≤

        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–∞–º—è—Ç—å
        - –ó–ê–ü–û–ú–ò–ù–ê–ô —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –†–ê–ú–ö–ê–• –û–î–ù–û–ì–û –î–ò–ê–õ–û–ì–ê
        - –ï—Å–ª–∏ —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã–∑–≤–∞–ª `analyze_uploaded_file_columns()` –∏ –ø–æ–ª—É—á–∏–ª –º–∞–ø–ø–∏–Ω–≥, –ò–°–ü–û–õ–¨–ó–£–ô –ï–ì–û –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        - –ù–ï –¢–ï–†–Ø–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –æ–¥–Ω–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ

        # –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

        ## –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (test_data.csv):
        1. `get_variance_data` - –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ variance
        2. `get_top_variances` - –Ω–∞–π—Ç–∏ —Ç–æ–ø –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π (–ø–æ –º–æ–¥—É–ª—é –∏–ª–∏ %)
        3. `get_summary_stats` - –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É: {self.data_file}

        ## –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏:
        4. `analyze_uploaded_file_columns` - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç–æ–ª–±—Ü—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥
        5. `apply_column_mapping` - –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∞–ø–ø–∏–Ω–≥ (—Ç—Ä–µ–±—É–µ—Ç 4 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: account_column, period_column, actual_column, budget_column)
        6. `get_mapped_variance_data` - –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–º–∞–ø–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        7. `get_mapped_top_variances` - —Ç–æ–ø –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –∏–∑ –∑–∞–º–∞–ø–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

        # Workflow –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

        **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –°–ª–µ–¥—É–π —ç—Ç–æ–º—É workflow –°–¢–†–û–ì–û –ø–æ —à–∞–≥–∞–º:

        ## –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞
        –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–≤—ã–π —Ñ–∞–π–ª:
        - –í—ã–∑–æ–≤–∏ `analyze_uploaded_file_columns()` –ù–ï–ú–ï–î–õ–ï–ù–ù–û
        - –≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–µ—Ä–Ω—ë—Ç —Ç–µ–±–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ–ª–±—Ü–∞—Ö –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥

        ## –®–∞–≥ 2: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞
        –ü–æ–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –≤ –ü–û–ù–Ø–¢–ù–û–ú —Ñ–æ—Ä–º–∞—Ç–µ:
        ```
        üìã –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤–∞—à —Ñ–∞–π–ª

        –ü—Ä–µ–¥–ª–∞–≥–∞—é —Å–ª–µ–¥—É—é—â–∏–π –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–æ–ª–±—Ü–æ–≤:
        ‚Ä¢ "[column1]" ‚Üí account (–Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞)
        ‚Ä¢ "[column2]" ‚Üí period (–ø–µ—Ä–∏–æ–¥)
        ‚Ä¢ "[column3]" ‚Üí actual (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)
        ‚Ä¢ "[column4]" ‚Üí budget (–±—é–¥–∂–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

        ‚úÖ –ù–∞–ø–∏—à–∏—Ç–µ "–¥–∞" —á—Ç–æ–±—ã —è –ü–†–ò–ú–ï–ù–ò–õ —ç—Ç–æ—Ç –º–∞–ø–ø–∏–Ω–≥ –∏ –Ω–∞—á–∞–ª –∞–Ω–∞–ª–∏–∑.
        ```

        **–í–ê–ñ–ù–û:** –°–û–•–†–ê–ù–ò —ç—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞!

        ## –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Ç—ã –ø—Ä–µ–¥–ª–æ–∂–∏–ª –º–∞–ø–ø–∏–Ω–≥, UI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –∏ –∂–¥—ë—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

        **–ù–û–í–´–ô WORKFLOW (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –°–õ–ï–î–£–ô):**

        1. **–ö–æ–≥–¥–∞ —Ç—ã –≤—ã–∑—ã–≤–∞–µ—à—å `analyze_uploaded_file_columns()`:**
           - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –≤ –ø–∞–º—è—Ç–∏ UI
           - –¢—ã –ø–æ–ª—É—á–∏—à—å –≤ –æ—Ç–≤–µ—Ç–µ –ø–æ–ª–µ `"awaiting_confirmation": true`
           - –ü–æ–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –≤ –∫—Ä–∞—Å–∏–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
           - –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

        2. **–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç (–ø–∏—à–µ—Ç "–¥–∞", "yes", "–æ–∫" –∏ —Ç.–¥.):**
           - UI –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
           - UI —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç `apply_column_mapping()` —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
           - –¢—ã –ø–æ–ª—É—á–∏—à—å —É–∂–µ –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞
           - –ü—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —É—Å–ø–µ—Ö–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã

        3. **–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –º–∞–ø–ø–∏–Ω–≥:**
           - UI –ø–µ—Ä–µ–¥–∞—Å—Ç —Ç–µ–±–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –¢–ï–ö–£–©–ò–ú –º–∞–ø–ø–∏–Ω–≥–æ–º –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
           - –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –∏ –ø–æ–π–º–∏, –∫–∞–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏
           - –ü—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫:
             * "Actual Amount –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å budget" ‚Üí –ø–æ–º–µ–Ω—è–π –º–µ—Å—Ç–∞–º–∏ actual –∏ budget
             * "Account —ç—Ç–æ Name" ‚Üí –∏–∑–º–µ–Ω–∏ account_column –Ω–∞ "Name"
             * "–ü–µ—Ä–∏–æ–¥ —ç—Ç–æ Date, –∞ –Ω–µ Month" ‚Üí –∏–∑–º–µ–Ω–∏ period_column –Ω–∞ "Date"
           - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∏ `apply_column_mapping()` —Å –ù–û–í–´–ú–ò –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
           - –ü–æ–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç—ã –∏–∑–º–µ–Ω–∏–ª

        **–í–ê–ñ–ù–û:**
        - –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ ("–¥–∞") - –ù–ï –≤—ã–∑—ã–≤–∞–π `apply_column_mapping()`, —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç UI
        - –ü—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∏ `apply_column_mapping()` —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

        **–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –î–ò–ê–õ–û–ì–û–í:**

        **–ü—Ä–∏–º–µ—Ä 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞**
        ```
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª]
        –ê–≥–µ–Ω—Ç: [–≤—ã–∑—ã–≤–∞–µ—Ç analyze_uploaded_file_columns()]
        –ê–≥–µ–Ω—Ç: "üìã –ü—Ä–µ–¥–ª–∞–≥–∞—é –º–∞–ø–ø–∏–Ω–≥: 'Account Name' ‚Üí account, 'Month' ‚Üí period, 'Actual Amount' ‚Üí actual, 'Budget Amount' ‚Üí budget. –ù–∞–ø–∏—à–∏—Ç–µ '–¥–∞' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–¥–∞"
        [UI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç apply_column_mapping()]
        –ê–≥–µ–Ω—Ç: "‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –ø—Ä–∏–º–µ–Ω—ë–Ω! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 10 —Å—Ç—Ä–æ–∫."
        ```

        **–ü—Ä–∏–º–µ—Ä 2: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞**
        ```
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª]
        –ê–≥–µ–Ω—Ç: [–≤—ã–∑—ã–≤–∞–µ—Ç analyze_uploaded_file_columns()]
        –ê–≥–µ–Ω—Ç: "üìã –ü—Ä–µ–¥–ª–∞–≥–∞—é –º–∞–ø–ø–∏–Ω–≥: 'Account Name' ‚Üí account, 'Month' ‚Üí period, 'Actual Amount' ‚Üí actual, 'Budget Amount' ‚Üí budget."
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "Actual Amount –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å budget"
        [UI –ø–µ—Ä–µ–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —Ç–µ–∫—É—â–∏–º –º–∞–ø–ø–∏–Ω–≥–æ–º –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π]
        –ê–≥–µ–Ω—Ç: [–ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å actual –∏ budget –º–µ—Å—Ç–∞–º–∏]
        –ê–≥–µ–Ω—Ç: [–≤—ã–∑—ã–≤–∞–µ—Ç apply_column_mapping(account='Account Name', period='Month', actual='Budget Amount', budget='Actual Amount')]
        –ê–≥–µ–Ω—Ç: "‚úÖ –ü–æ–Ω—è–ª! –Ø —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª –º–∞–ø–ø–∏–Ω–≥: 'Budget Amount' ‚Üí actual, 'Actual Amount' ‚Üí budget. –ü—Ä–∏–º–µ–Ω—è—é..."
        ```

        ## –®–∞–≥ 4: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞
        –ö–æ–≥–¥–∞ `apply_column_mapping()` –≤–µ—Ä–Ω—ë—Ç success=True:
        - –°–æ–æ–±—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —É—Å–ø–µ—Ö–µ
        - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û:
          * `get_mapped_variance_data` - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
          * `get_mapped_top_variances` - –¥–ª—è —Ç–æ–ø –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
        - **–ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
          * `get_variance_data` (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å test_data.csv)
          * `get_top_variances` (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å test_data.csv)
          * `get_summary_stats` (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å test_data.csv)

        **–ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨:** –ï—Å–ª–∏ —Ç—ã —Ö–æ—Ç—å —Ä–∞–∑ –≤—ã–∑–≤–∞–ª `apply_column_mapping()` –∏–ª–∏ –≤–∏–¥–∏—à—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ "[SYSTEM] –ú–∞–ø–ø–∏–Ω–≥ —Ñ–∞–π–ª–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—ë–Ω", –∑–Ω–∞—á–∏—Ç –º–∞–ø–ø–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û get_mapped_* –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.

        # –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤
        - –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å –¥–∞–Ω–Ω—ã–µ (—Ç–∞–±–ª–∏—Ü–∞)
        - –ü–æ—Ç–æ–º –¥–∞—ë—à—å –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ –≤—ã–≤–æ–¥—ã
        - –î–ª—è –±–æ–ª—å—à–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

        # –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - "–ö–∞–∫–∏–µ —Å—á–µ—Ç–∞ –∏–º–µ—é—Ç –Ω–∞–∏–±–æ–ª—å—à–µ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ?"
        - "–ü–æ–∫–∞–∂–∏ —Ç–æ–ø-5 –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –≤ —è–Ω–≤–∞—Ä–µ 2024"
        - "–ö–∞–∫–∞—è –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º?"
        - "–ì–¥–µ –º—ã –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–ª–∏ –±—é–¥–∂–µ—Ç?"
        """
    
    async def chat(self, message: str) -> str:
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.

        Args:
            message: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –û—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞
        """

        result = await Runner.run(self.agent, message, session=self.session)

        return result.final_output
    
    def chat_sync(self, message: str) -> str:
        """
        –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è chat() –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞.

        Args:
            message: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –û—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞
        """
        return Runner.run_sync(self.chat, message, session=self.session)
    
    async def chat_stream(self, message: str):
        """
            –°—Ç—Ä–∏–º—è—â–∞—è –≤–µ—Ä—Å–∏—è chat() - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

            Args:
                message: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            Yields:
                str: –¢–æ–∫–µ–Ω—ã –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞

            –ü–æ–¥—Å–∫–∞–∑–∫–∏:
            1. –ò—Å–ø–æ–ª—å–∑—É–π Runner.run_stream() –≤–º–µ—Å—Ç–æ Runner.run()
            2. –ò—Ç–µ—Ä–∏—Ä—É–π—Å—è –ø–æ stream: async for event in stream
            3. –ü—Ä–æ–≤–µ—Ä—è–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ yield —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
            4. –°–æ–±—ã—Ç–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ - –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ

            –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è OpenAI Agents SDK:
            - Runner.run_stream() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç AsyncIterator[Event]
            - –°–æ–±—ã—Ç–∏—è –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã: text_delta, tool_name, final_output
            """
        result = Runner.run_streamed(
            starting_agent=self.agent,
            input=message,
            context=self.session
        )

        stream = result.stream_events()

        async for event in stream:
            if hasattr(event, "data") and event.data.type == "response.output_text.delta":
                yield event.data.delta
                # sleep(0.5)
    
async def interactive_mode(data_file: str):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∞–≥–µ–Ω—Ç–∞ –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ."""

        analyst = VarianceAnalyst(data_file) 
        print("ü§ñ Variance Analyst –∑–∞–ø—É—â–µ–Ω –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ")
        print("–í–≤–µ–¥–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ 'quit' –¥–ª—è –≤—ã—Ö–æ–¥–∞\n")

        await run_demo_loop(analyst.agent, context=analyst.session)

